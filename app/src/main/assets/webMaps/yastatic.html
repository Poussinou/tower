<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>A Static Yandex Map</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <script src="utils.js"></script>
</head>

<body>
  <p id="ind"></p>
  <img id="mapImg" style="width: 600px; height: 400px" />
<script>
  function UriBuilder() {
    var base="https://static-maps.yandex.ru/1.x/?";
    var res=base;
    var ll;
    
    this.getExample=function() {
      var example="https://static-maps.yandex.ru/1.x/?ll=37.620070,55.753630&size=450,450&z=13&l=map&pt=37.620070,55.753630,pmwtm1~37.64,55.76363,pmwtm99";
      return example;
    };
    
    this.setLonLat=function(lonlat,lat) {
      if ( ! parseInt(lonlat)) throw new Error("Empty argument");
      ll=lonlat;
      if ( !! lat && lonlat.toString().indexOf(",") < 0) ll=lonlat.toString().concat(","+lat);
      add("ll="+ll);
      return this;
    };
    
    this.setWH=function(wh,h) {
      var size=wh;
      if ( !! h && wh.indexOf(",") < 0) {    
        size=parseInt(wh).toString().concat(",".concat(parseInt(h)));
      }
      add("size="+size);
      return this;
    };
    
    this.setZ=function(z) {
      add("z="+z);
      return this;
    };
    
    this.setType=function(t) {
      var l="map", ch=t.charAt(0);
      if (ch == "s") l="sat";
      else if (ch == "h") l="sat,skl";
      add("l="+l);
      return this;
    };
    
    this.markCenter=function(mark) {
      var m="round";// "flag","home"
      if (mark) m=mark;
      if ( ! ll) alert("Set the center first");
      var pt=ll+","+m;
      add("pt="+pt);
      return this;
    };
    
    this.getString=function() {
      return res;
    };
    
    function add(s) {
      var last=res.charAt(res.length - 1);
      if (last != "?" && last !="&") res=res.concat("&");
      res=res.concat(s);
    }  
  }
  
  var ind=new wm.utils.Ind(document.getElementById("ind"));
  var ll="37.7759262544,55.79038894644";
  var zoom=16;
  var type="gps";
  if (typeof JSbridge == "undefined") ind.say("mock coords");
  else {
    ll=JSbridge.importLonLat();
    zoom=JSbridge.importZoom();
    type=JSbridge.importType();
    ind.say(ll+",z="+zoom);
  }
  
  var scrInfo=wm.utils.getScreenParams();
  ind.say("w/h="+scrInfo.width+"/"+scrInfo.height);
  var img=document.getElementById("mapImg");
  var w=""+Math.min(scrInfo.width,650);// limited by Yandex
  var h=""+Math.min(scrInfo.height,450);
  img.style.width=w+"px";
  img.style.height=h+"px";
  var marks={ cell:"round", gps:"home", mark:"flag" };
  
  //img.src=new UriBuilder().getExample();
  var u=new UriBuilder()
    .setLonLat(ll)
    .setType("s")
    .setWH(w,h)
    .setZ(zoom)
    .markCenter(marks[type])
    .getString();
  //console.log(u);
  ind.say("\nrequesting "+u);
  img.onerror=function(){ ind.say("No response, is your network Ok?"); };
  //img.onload=function(){ ind.hide(); };
  img.src=u;
  
</script>    
</body>
</html>